---
title: "State Level Mobility Report"
author: "Brian Harrold"
format: 
  html: 
    self-contained: true
execute: 
  cache: false
---

```{r setup}
#| echo: false

library(cohortED)
library(ggplot2)
library(cowplot)

```

## Overview

This short report provides a brief summary of the trends in the student cohorts and student mobility. This will focus on the state mathematics assessment from the 2023-2024 academic year, but illustrate trends over previous academic years.

## Definitions

- **Leave** A student has a mobility status of "leave" if there was a record for the previous academic year, but the student is not present in the data for the current academic year.
- **Stay** A student is classified as having a "stay" mobility status if they are present in the data set for both the previous academic year and the current academic year.
- **Join** A student has a mobility status of "join" when the student is present in the current academic year's data set, but the student did not appear in the previous data set.

## General Trends in Student Mobility and Cohorts

Based on the table below, the overall trend for students for the 2023-2024 academic year seem to be that there is little difference in the mobility of students based on the grade level. Approximately 80% of students from each grade in 2023-2024 continued from the previous grade during the previous academic year. Students appear to be joining at a slightly higher rate than leaving.

```{r table_of_years}
#| echo: false

change <- plot_distribution_mobility(dataset = math, 
                                     current_year = "2023_2024",
                                     start_grade = 4, 
                                     end_grade = 6, 
                                     print_plot = FALSE)

knitr::kable(change$Table, 
             caption = change$Caption, 
             align = rep("r", ncol(change$Table)))
```

Also of interest is how these cohorts of students compare to one another and to previous cohorts of students. This is evident in the plot shown below. Until more recently, it was common for the percent proficient to increase from Grade 3 to Grade 4. However, this appears to have reversed post-COVID. Additionally, it appears that the percent proficient decreases between Grade 4 and Grade 5, with a much sharper decline in the recent years. It also appears that while most cohorts start with approximately the same proficiency rate in Grade 3, the gap tends to widen as the grade levels increase.

```{r spaghetti}
#| echo: false
#| eval: FALSE

prof1 = make_proficiency_levels(dataset = math, n_proficiencies = 2, print_table = FALSE, 
                                make_plot = FALSE)

df.new = data.frame(
  grade = integer(), 
  year = integer(), 
  np = numeric(), 
  p = numeric(), 
  stringsAsFactors = FALSE
)

g = rep(c(5, 4, 3), 5)
y = rep(c(2024, 2023, 2022, 2021, 2020), each = 3)

year_char = paste0((y-1), "_", y)

for(i in 1:length(g)) {
  table.new = table(prof1[prof1$GRADE == g[i] & prof1$YEAR == year_char[i],
                          "PROFICIENCY_LEVELS"])
  proptable.new = round(prop.table(table.new), 3) * 100
  TEMP = data.frame(
    grade = g[i], 
    year = y[i], 
    np = as.numeric(proptable.new["Not Proficient"]), 
    p = as.numeric(proptable.new["Proficient"])
  )
  df.new = rbind(df.new, TEMP)
}

df.new$cohort = df.new$year - df.new$grade + 3

ggplot(df.new, aes(x = grade, y = p, group = cohort, color = as.factor(cohort))) +
  geom_point(size = 3) +
  geom_line(linewidth = 1) +
  scale_color_brewer(palette = "Dark2") +  
  scale_x_continuous(breaks = seq(min(df.new$grade), max(df.new$grade), 1)) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  labs(
    x = "Grade",
    y = "Percent Proficient",
    title = "Percent Proficient by Cohort",
    color = "Grade 3 in "  # <-- Custom legend title here
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom")

```


## Deep Dive into Student Mobility and Cohorts

This section focuses on the students who were in Grade 4 during the 2022-2023 academic year and are currently Grade 5 during the 2023-2024 academic year. The alluvial diagram shows the interaction between student mobility, gender, and ethnicity for those students. From this diagram it appears that there is little difference in student mobility by gender, however there are some concerns regarding student mobility and ethnicity.


```{r alluvial}
#| echo: FALSE

grade5 = plot_alluvial_mobility(dataset = math, 
                                current_year = "2023_2024", 
                                current_grade = 5)
```

As shown in the table below, the non-white student population generally experiences a higher rate of student mobility. This is incredibly evident with a much higher proportion of African American students leaving between the 2022-2023 and 2023-2024 academic years. Similarly, students who are Native American also experience a higher rate of student mobility in both directions.

```{r ethnicity_table}
#| echo: FALSE
#| eval: FALSE

knitr::kable(grade5$Table_by_Ethnicity, 
             caption = grade5$Caption, 
             align = rep("r", ncol(grade5$Table_by_Ethnicity)))

```

As research suggests, student mobility has an impact on student performance. To further see these results, consider the plots below which show the achievement levels for the students who were in Grade 4 during 2022-2023 and Grade 5 during 2023-2024. That is, the "stay" mobility status are the same cohort of students. As expected, their achievement levels change slightly from one academic year to the next. However, there is a big difference in the achievement levels between the students who stayed as compared to those students who experience mobility. Those students who either left or joined between the 2022-2023 and 2023-2024 school years had lower proficiency and advanced rates, than their counterparts.

```{r student_performance}
#| echo: FALSE
#| eval: FALSE

grade4.x = grade4[!is.na(grade4$ACHIEVEMENT_LEVEL.x) & 
                    grade4$ACHIEVEMENT_LEVEL.x != "No Score", ]
grade4.y = grade4[!is.na(grade4$ACHIEVEMENT_LEVEL.y) & 
                    grade4$ACHIEVEMENT_LEVEL.y != "No Score", ]

table1 = table(grade4.x$MOBILITY_STATUS, grade4.x$ACHIEVEMENT_LEVEL.x)
df1 = data.frame(round(prop.table(table1, margin = 1), 3))
df1 = df1[!is.nan(df1$Freq), ]
df1$Var2 = factor(df1$Var2, 
                  levels = c("Advanced", "Proficient", 
                             "Partially Proficient", "Unsatisfactory"))

table2 = table(grade4.y$MOBILITY_STATUS, grade4.y$ACHIEVEMENT_LEVEL.y)
df2 = data.frame(round(prop.table(table2, margin = 1), 3))
df2 = df2[!is.nan(df2$Freq), ]
df2$Var2 = factor(df2$Var2, 
                  levels = c("Advanced", "Proficient", 
                             "Partially Proficient", "Unsatisfactory"))

plot1 = ggplot(df1, aes(x = Var1, y = Freq, fill = Var2)) + 
  geom_bar(stat = "identity") + 
  labs(title = "2022-2023", y = "Value", x = "Mobility Status", 
       fill = "Achievement Level") + 
  theme_minimal() +
  scale_fill_manual(values = c(
    "Advanced" = "#2E8B57",
    "Proficient" = "#66CDAA",
    "Partially Proficient" = "#E57373",
    "Unsatisfactory" = "#B22222"
  ))

plot2 = ggplot(df2, aes(x = Var1, y = Freq, fill = Var2)) + 
  geom_bar(stat = "identity") + 
  labs(title = "2023-2024", y = "Value", x = "Mobility Status", 
       fill = "Achievement Level") + 
  theme_minimal() +
  scale_fill_manual(values = c(
    "Advanced" = "#2E8B57",
    "Proficient" = "#66CDAA",
    "Partially Proficient" = "#E57373",
    "Unsatisfactory" = "#B22222"
  ))

plot_grid(plot1, plot2, ncol = 2)

```


## Data Notes

This is an example report based on the sgpData_Long that is contained in the SGPData package, which has been subset to only include the data associated the **Mathematics** Content Area. While the data does not truly represent student attendance, the general functionality  readily accounts for student entering and exiting the data.





